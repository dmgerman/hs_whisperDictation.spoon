#+title: WhisperDictation Spoon
#+author: dmg
#+date: 2025
#+language: en

* Overview

WhisperDictation is a [[https://www.hammerspoon.org/][Hammerspoon]] Spoon that provides local, offline voice dictation powered by [[https://openai.com/research/whisper][OpenAI's Whisper]] model.

Records audio from your microphone, transcribes it locally, and copies the text to your clipboard. A menubar indicator shows recording status and elapsed time.

** Key Features

- Local voice-to-text transcription (no cloud required)
- Multi-language support
- Automatic clipboard copy
- Asynchronous processing
- Configurable recording timeout
- Multiple transcription backends

* Requirements

** sox (required)

#+begin_src bash
brew install sox
#+end_src

** Transcription Backend (choose one)

*** WhisperKit CLI

Apple-optimized implementation. Models download automatically on first use.

#+begin_src bash
brew install whisperkit-cli
#+end_src

Available models: =tiny=, =base=, =small=, =medium=, =large-v3= (best accuracy, slowest)

*** Whisper CLI (default)

C++ implementation via [[https://github.com/ggerganov/whisper.cpp][whisper.cpp]]. Requires manual model download.

#+begin_src bash
brew install whisper-cli

# Download model
mkdir -p /usr/local/whisper && cd /usr/local/whisper
wget https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-large-v3.bin
#+end_src

*** Whisper Server

Persistent HTTP server - fastest for repeated use since model stays loaded.

#+begin_src bash
# Build from whisper.cpp
git clone https://github.com/ggerganov/whisper.cpp
cd whisper.cpp && mkdir build && cd build
cmake .. && cmake --build . --config Release

# Download model (same as Whisper CLI)
#+end_src

* Installation

Add to your =~/.hammerspoon/init.lua=:

#+begin_src lua
wd = hs.loadSpoon("hs_whisperDictation")
wd.languages = {"en", "ja", "es", "fr"}
wd:bindHotKeys({
    toggle = {{"ctrl", "cmd"}, "d"},
    nextLang = {{"ctrl", "cmd"}, "l"},
})
wd:start()
#+end_src

** Backend Configuration

*WhisperKit CLI:*
#+begin_src lua
wd.transcriptionMethod = "whisperkitcli"
wd.transcriptionMethods.whisperkitcli.config.model = "large-v3"
#+end_src

*Whisper CLI (default):*
#+begin_src lua
wd.transcriptionMethod = "whispercli"
wd.transcriptionMethods.whispercli.config.modelPath = "/usr/local/whisper/ggml-large-v3.bin"
#+end_src

*Whisper Server:*
#+begin_src lua
wd.transcriptionMethod = "whisperserver"
wd.serverConfig.executable = "/path/to/whisper-server"
wd.serverConfig.modelPath = "/usr/local/whisper/ggml-large-v3-turbo.bin"
#+end_src

* Configuration

** Properties

| Property                 | Default                 | Description                                             |
|--------------------------+-------------------------+---------------------------------------------------------|
| =transcriptionMethod=    | "whispercli"            | Backend: whisperkitcli/whispercli/whisperserver         |
| =languages=              | {"en"}                  | Available languages                                     |
| =tempDir=                | "/tmp/whisper_dict"     | Recording storage directory                             |
| =timeoutSeconds=         | 1800                    | Auto-stop timeout (nil to disable)                      |
| =showRecordingIndicator= | true                    | Show red circle while recording                         |

For detailed customization (icons, indicator styling, logging, server config), see [[file:configuration.org][configuration.org]].

* Usage

** Recording

1. Press toggle hotkey (default: Ctrl+Cmd+D) or click menubar icon to start
2. Menubar shows elapsed time and language
3. Press again to stop - audio is transcribed and copied to clipboard

** Language Switching

Press language hotkey (default: Ctrl+Cmd+L) to open chooser.

** Files Generated

#+begin_src
/tmp/whisper_dict/
├── en-20240101-120000.wav    # Audio
├── en-20240101-120000.txt    # Transcript
#+end_src

* API Reference

** Core Methods

- =start()= - Initialize spoon and menubar
- =stop()= - Clean up and remove menubar
- =toggleTranscribe()= - Toggle recording on/off
- =bindHotKeys(mapping)= - Bind hotkeys

** Recording with Callback

#+begin_src lua
wd:beginTranscribe(function(text)
  -- Custom handling instead of clipboard
  print("Got: " .. text)
end)
-- ... later ...
wd:endTranscribe()
#+end_src

** Server Methods (whisperserver only)

=startServer()=, =stopServer()=, =isServerRunning()=, =ensureServer()= - See [[file:configuration.org][configuration.org]].

** Logger

#+begin_src lua
wd.logger:setLevel("DEBUG")  -- DEBUG/INFO/WARN/ERROR
#+end_src

* Troubleshooting

** Enable Debug Logging

#+begin_src lua
wd.logger:setLevel("DEBUG")
-- View: Hammerspoon menu → Console
#+end_src

** Common Issues

- *"recording command not found"*
  - Check sox: =which sox=

- *"transcription method not found"*
  - Check backend: =which whisperkit-cli= or =which whisper-cli=

- *Empty transcription*
  - Verify audio recorded:

#+begin_src bash
ls -t /tmp/whisper_dict/*.wav | head -1
afplay /tmp/whisper_dict/your-file.wav
#+end_src

*- No audio*
- Check microphone in System Preferences → Sound → Input

* Development

For architecture, extending with custom methods, and contributing, see [[file:development.org][development.org]].

* License

MIT License - See LICENSE file for details.

* See Also

- [[https://www.hammerspoon.org/][Hammerspoon Documentation]]
- [[https://github.com/argmaxinc/whisperkit-cli][WhisperKit CLI Repository]]
- [[https://github.com/ggerganov/whisper.cpp][whisper.cpp Repository]]
