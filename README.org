#+title: WhisperDictation Spoon
#+author: dmg
#+date: 2025
#+language: en

* Overview

WhisperDictation is a [[https://www.hammerspoon.org/][Hammerspoon]] Spoon that provides local, offline voice dictation powered by [[https://openai.com/research/whisper][OpenAI's Whisper]] model.

It records audio from your microphone and transcribes it using =whisperkit-cli=, then automatically copies the transcribed text to your clipboard. Both recording and transcription happen asynchronously, allowing you to continue working without interruption. A menubar indicator shows recording status and elapsed time.

** Key Features

- üéôÔ∏è Local voice-to-text transcription (no cloud required)
- üåê Multi-language support (English, Japanese, Spanish, French, etc.)
- üìã Automatic clipboard copy with character count
- ‚ö° Asynchronous processing - continue working while transcription happens in the background
- ‚è±Ô∏è Elapsed time indicator during recording
- üîç Structured logging with file and console output
- ‚å®Ô∏è Customizable hotkeys
- üíæ Transcript files saved alongside audio

* Requirements

Before using WhisperDictation, ensure you have the following installed:

** Dependencies

1. [[https://sox.sourceforge.net/][sox]] - Audio recording tool
   #+begin_src bash
   brew install sox
   #+end_src

2. [[https://github.com/argmaxinc/whisperkit-cli][whisperkit-cli]] - Whisper transcription CLI
   #+begin_src bash
   brew install whisperkit-cli
   #+end_src

* Installation

1. Clone or download the Spoon into your Hammerspoon Spoons directory:
   #+begin_src bash
   ~/.hammerspoon/Spoons/hs_whisperDictation.spoon/
   #+end_src

2. Add to your Hammerspoon config (~/.hammerspoon/init.lua):
   #+begin_src lua
   wd = hs.loadSpoon("hs_whisperDictation")
   wd.model = "large-v3"
   wd.languages = {"en", "ja", "es", "fr"}
   wd:bindHotKeys({
       toggle = {{"ctrl", "cmd"}, "d"},
       nextLang = {{"ctrl", "cmd"}, "l"},
   })
   wd:start()
   #+end_src

3. Reload Hammerspoon configuration

** Customizable Properties

| Property   | Type   | Default                            | Description                   |
|------------+--------+------------------------------------+-------------------------------|
| =model=      | string | "large-v3"                         | Whisper model size            |
| =tempDir=    | string | "/tmp/whisper_dict"                | Temp directory for recordings |
| =recordCmd=  | string | "/opt/homebrew/bin/sox"            | Path to sox binary            |
| =whisperCmd= | string | "/opt/homebrew/bin/whisperkit-cli" | Path to whisperkit-cli binary |
| =languages=  | table  | {"en"}                             | List of supported languages   |
| =icons=      | table  | See below                          | Emoji icons for UI states     |

** Model Selection

The Whisper model determines transcription accuracy and speed. Available models include:

| Model      | Accuracy | Speed   | Size  |
|------------+----------+---------+-------|
| tiny       | Low      | Fastest | 39M   |
| base       | Fair     | Fast    | 140M  |
| small      | Good     | Medium  | 466M  |
| medium     | Better   | Slower  | 1.5G  |
| large-v3   | Best     | Slowest | 2.9G  |

‚ö†Ô∏è *Warning*: Transcription time depends heavily on the model chosen and the length of audio. Larger models provide better accuracy but take significantly longer to process. For example, a 10-second recording might take 5-10 seconds with "tiny" but several minutes with "large-v3" on standard hardware.

‚ö†Ô∏è *First-Time Model Download*: The first time you use a model, it will be automatically downloaded (this happens only once). Download times vary by model size and internet speed. Ensure you have sufficient disk space and a stable internet connection when first running the Spoon with a new model.

Set the model in your config:

#+begin_src lua
wd.model = "large-v3"  -- or "tiny", "base", "small", "medium"
#+end_src

** Icon Customization

You can customize the emoji icons used throughout the Spoon. Available icons are:

| Icon              | Property        | Default | Usage                      |
|-------------------+-----------------+---------+----------------------------|
| =idle=            | obj.icons.idle  | üé§      | Idle/ready state           |
| =recording=       | obj.icons.recording | üéôÔ∏è      | During recording           |
| =clipboard=       | obj.icons.clipboard | üìã      | Text copied to clipboard   |
| =language=        | obj.icons.language | üåê      | Language switching         |
| =stopped=         | obj.icons.stopped | üõë      | Recording stopped          |
| =transcribing=    | obj.icons.transcribing | ‚è≥      | During transcription       |
| =error=           | obj.icons.error | ‚ùå      | Error notifications        |
| =info=            | obj.icons.info  | ‚ÑπÔ∏è      | Info notifications         |

Customize icons in your Hammerspoon config:

#+begin_src lua
wd.icons.idle = "üéôÔ∏è"
wd.icons.recording = "üî¥"
wd.icons.clipboard = "‚úÖ"
#+end_src

** Hotkey Binding

Define custom hotkeys using the =bindHotKeys()= method:

#+begin_src lua
wd:bindHotKeys({
    toggle = {{"ctrl", "cmd"}, "d"},      -- Start/stop recording
    nextLang = {{"ctrl", "cmd"}, "l"},    -- Open language chooser
})
#+end_src

** Logging Configuration

#+begin_src lua
-- Enable file logging, disabled by default
wd.logger.enableFile = true
wd.logger.logFile = os.getenv("HOME") .. "/.hammerspoon/Spoons/hs_whisperDictation/whisper.log"

-- Set log level (DEBUG, INFO, WARN, ERROR)
wd.logger:setLevel("DEBUG")
#+end_src

* Usage

** Starting Recording

Click the menubar icon (üé§) or press your configured toggle hotkey (default: Ctrl+Cmd+D).

The menubar will update to show:
- üéôÔ∏è Recording indicator
- Elapsed time in seconds
- Current language code

** Stopping Recording

Click the menubar icon again or press the toggle hotkey.

The audio is automatically transcribed asynchronously in the background, and the text is copied to your clipboard once transcription completes. You can continue working while transcription happens without waiting for it to finish.

‚ö†Ô∏è *Warning*: It is technically possible to start a new recording while transcription is still in progress. However, the menubar interface may not properly reflect the current state in this scenario. Use with caution to avoid confusion.

** Switching Languages

Press your language switch hotkey (default: Ctrl+Cmd+L) to open a language chooser menu displaying all available languages. The currently active language is marked with a "‚úì Selected" indicator.

The menubar will update to show the new language code.

** Files Generated

Recordings and transcripts are stored in =tempDir=:

#+begin_src
/tmp/whisper_dict/
‚îú‚îÄ‚îÄ en-20240101-120000.wav    # Audio file
‚îú‚îÄ‚îÄ en-20240101-120000.txt    # Transcript
‚îî‚îÄ‚îÄ ...
#+end_src

* API Reference

** Methods

*** =start()=
Initializes the Spoon and sets up the menubar.

#+begin_src lua
wd:start()
#+end_src

*** =stop()=
Stops the Spoon, cleans up resources, and removes the menubar.

#+begin_src lua
wd:stop()
#+end_src

*** =bindHotKeys(mapping)=
Binds hotkeys for controlling the Spoon.

#+begin_src lua
wd:bindHotKeys({
    toggle = {{"ctrl", "cmd"}, "d"},
    nextLang = {{"ctrl", "cmd"}, "l"},
})
#+end_src

** Logger Methods

The Spoon includes a custom logger accessible via =obj.logger=:

- =logger:debug(msg)= - Debug level message
- =logger:info(msg, showAlert)= - Info level message (optional alert)
- =logger:warn(msg, showAlert)= - Warning level message (shows alert by default)
- =logger:error(msg, showAlert)= - Error level message (shows alert by default)
- =logger:setLevel(level)= - Set log level ("DEBUG", "INFO", "WARN", "ERROR")

* Troubleshooting

** "whisperkit-cli not found"

Ensure =whisperkit-cli= is installed and the path in =obj.whisperCmd= is correct:

#+begin_src bash
which whisperkit-cli
#+end_src

Update the path in your config if needed:

#+begin_src lua
wd.whisperCmd = "/path/to/whisperkit-cli"
#+end_src

** "recording command not found"

Similarly, check =sox= is installed:

#+begin_src bash
which sox
#+end_src

Update the path if necessary:

#+begin_src lua
wd.recordCmd = "/path/to/sox"
#+end_src

** Transcription Produces Empty Output

- Ensure your microphone is working and not muted
- Check log file for detailed error messages:
  #+begin_src bash
  tail -f ~/.hammerspoon/Spoons/hs_whisperDictation/whisper.log
  #+end_src
- Try a longer recording (Whisper needs sufficient audio)

** Audio Not Being Recorded

- Verify =sox= permissions
- Check microphone is selected in System Preferences
- Test recording manually:
  #+begin_src bash
  sox -d /tmp/test.wav
  #+end_src

* Architecture

The Spoon consists of several key components:

** Logger System
Custom structured logging with support for multiple levels and outputs (console and file).

** Recording Manager
Handles audio input via =sox= and manages the recording lifecycle.

** Transcription Handler
Sends audio to =whisperkit-cli= and processes the output.

** Language Manager
Tracks current language and provides language switching functionality.

** Menubar Interface
Provides visual feedback on recording status and allows UI interaction.

* License

MIT License - See LICENSE file for details.

* Contributing

Bug reports and suggestions are welcome. Please open an issue or submit a pull request.

* See Also

- [[https://www.hammerspoon.org/][Hammerspoon Documentation]]
- [[https://github.com/argmaxinc/whisperkit-cli][WhisperKit CLI Repository]]
- [[https://github.com/openai/whisper][OpenAI Whisper Repository]]
