#+title: WhisperDictation Configuration Reference
#+author: dmg
#+date: 2025
#+language: en

Detailed configuration options for WhisperDictation. For basic setup, see [[file:README.org][README.org]].

* Icon Customization

You can customize the emoji icons used throughout the Spoon:

| Icon           | Property               | Default | Usage                    |
|----------------+------------------------+---------+--------------------------|
| =idle=         | obj.icons.idle         | üé§      | Idle/ready state         |
| =recording=    | obj.icons.recording    | üéôÔ∏è      | During recording         |
| =clipboard=    | obj.icons.clipboard    | üìã      | Text copied to clipboard |
| =language=     | obj.icons.language     | üåê      | Language switching       |
| =stopped=      | obj.icons.stopped      | üõë      | Recording stopped        |
| =transcribing= | obj.icons.transcribing | ‚è≥      | During transcription     |
| =error=        | obj.icons.error        | ‚ùå      | Error notifications      |
| =info=         | obj.icons.info         | ‚ÑπÔ∏è      | Info notifications       |

Example:
#+begin_src lua
wd.icons.idle = "üéôÔ∏è"
wd.icons.recording = "üî¥"
wd.icons.clipboard = "‚úÖ"
#+end_src

* Recording Indicator

A large red circle appears in the center of your screen while recording.

** Disabling the Indicator

#+begin_src lua
wd.showRecordingIndicator = false
#+end_src

** Customizing Appearance

Colors are RGBA with values from 0.0 to 1.0:

#+begin_src lua
wd.recordingIndicatorStyle = {
  fillColor = {red = 1, green = 0, blue = 0, alpha = 0.7},
  strokeColor = {red = 1, green = 0, blue = 0, alpha = 1},
  strokeWidth = 2,
}
#+end_src

Examples:
#+begin_src lua
-- Semi-transparent yellow circle with blue border
wd.recordingIndicatorStyle = {
  fillColor = {red = 1, green = 1, blue = 0, alpha = 0.6},
  strokeColor = {red = 0, green = 0, blue = 1, alpha = 1},
  strokeWidth = 3,
}

-- Green circle with no border
wd.recordingIndicatorStyle = {
  fillColor = {red = 0, green = 1, blue = 0, alpha = 0.7},
  strokeColor = {red = 0, green = 1, blue = 0, alpha = 0},
  strokeWidth = 0,
}
#+end_src

* Recording Timeout

Recordings automatically stop after a specified duration to prevent unattended recordings.

** Configuration

#+begin_src lua
wd.timeoutSeconds = 1800  -- Default: 30 minutes
wd.timeoutSeconds = 60    -- Stop after 1 minute
wd.timeoutSeconds = nil   -- Disable timeout completely
#+end_src

** Behavior

- When timeout is reached, recording stops automatically
- Warning notification: "üõë Recording auto-stopped due to timeout"
- Audio is transcribed normally

* Logging Configuration

Default: INFO-level messages to Hammerspoon console.

** Options

#+begin_src lua
-- Console logging (enabled by default)
wd.logger.enableConsole = true

-- File logging (disabled by default)
wd.logger.enableFile = true
wd.logger.logFile = os.getenv("HOME") .. "/.hammerspoon/Spoons/hs_whisperDictation/whisper.log"

-- Log level: DEBUG, INFO (default), WARN, ERROR
wd.logger:setLevel("DEBUG")
#+end_src

** Viewing Logs

- *Console*: Hammerspoon menu ‚Üí Console (real-time)
- *File*: =tail -f ~/.hammerspoon/Spoons/hs_whisperDictation/whisper.log= (requires =enableFile = true=)

* Server Configuration (whisperserver method)

Full configuration options for the HTTP server backend:

#+begin_src lua
wd.serverConfig = {
  executable = "/path/to/whisper-server",
  modelPath = "/usr/local/whisper/ggml-model.bin",
  modelPathFallback = "/usr/local/whisper/ggml-large-v3-turbo.bin",
  host = "127.0.0.1",
  port = "8080",
  startupTimeout = 10,  -- seconds to wait for server
  curlCmd = "/usr/bin/curl",
}
#+end_src

** Server Lifecycle

- *Auto-start*: Server starts asynchronously when spoon starts (non-blocking)
- *Auto-stop*: Server stops when spoon stops
- *Auto-restart*: Server restarts on language change
- *External servers*: If a server is already running on the port, it will be used (not stopped on spoon stop)
- *Startup notifications*: Alerts shown when server is starting and when ready

** Manual Control

#+begin_src lua
wd:startServer()           -- Start server asynchronously (non-blocking)
wd:startServer(callback)   -- Start with callback: callback(success, error_message)
wd:stopServer()            -- Stop server (only if managed by spoon)
wd:isServerRunning()       -- Check health
wd:ensureServer(callback)  -- Start if not running, callback when ready
#+end_src

** Transcription Before Server Ready

If transcription is attempted before the server is ready:
- An alert is shown: "Server starting... please try again when ready"
- The transcription request fails gracefully
- The server continues starting in the background
- Once the server is ready, an alert shows: "Whisper server ready"

* Python Stream Backend Configuration

The Python stream backend uses a persistent TCP server for continuous recording with VAD-based chunking.

** Basic Configuration

#+begin_src lua
wd.recordingBackend = "pythonstream"

wd.pythonstreamConfig = {
  port = 12341,                  -- TCP server port
  host = "127.0.0.1",
  serverStartupTimeout = 5.0,    -- Seconds to wait for server
}
#+end_src

** Advanced Configuration

Backend-specific settings (applied automatically from pythonstreamConfig):

#+begin_src lua
wd.recordingBackends.pythonstream.config = {
  pythonCmd = os.getenv("HOME") .. "/.config/dmg/python3.12/bin/python3",
  scriptPath = "<set automatically by spoon>",
  host = "127.0.0.1",
  port = 12341,
  serverStartupTimeout = 5.0,
  silenceThreshold = 2.0,      -- Seconds of silence to trigger chunk
  minChunkDuration = 10.0,     -- Minimum chunk length (seconds)
  maxChunkDuration = 120.0,    -- Maximum chunk length (seconds)
}
#+end_src

** Server Lifecycle

- *Auto-start*: Server starts asynchronously 0.5s after spoon initialization (non-blocking)
- *Persistent*: Server stays running between recordings (VAD model loaded once)
- *Auto-cleanup*: Zombie processes killed before starting
- *Auto-stop*: Server shutdown gracefully when spoon stops
- *Performance*:
  - First recording after reload: ~2-3s (VAD model loading, one-time)
  - All subsequent recordings: Instant (server already running)

** Chunk Behavior

- *Silence detection*: 2.0s of silence triggers chunk save
- *Minimum duration*: Chunks shorter than 10s ignored (unless final)
- *Maximum duration*: Chunks auto-split at 120s
- *Final chunk*: Always saved regardless of duration
- *Real-time*: Chunks transcribed as they arrive

** Emacs Paste Integration

When using auto-paste mode, the spoon can detect Emacs and use Ctrl-Y instead of Cmd-V:

#+begin_src lua
wd.pasteWithEmacsYank = true  -- Use Ctrl-Y in Emacs (org.gnu.Emacs)
#+end_src

This ensures transcribed text pastes correctly in Emacs without interfering with other applications.
